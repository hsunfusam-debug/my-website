<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¾—çæŸ¥è©¢ - å¯Œå£«è»Ÿç‰‡æ—ºå¹´æœƒ</title>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --fuji-red: #d32f2f;
            --fuji-dark: #1a1a1a;
            --gold: #ffd700;
            --metallic-gold: linear-gradient(135deg, #fff7ad 0%, #ffa700 50%, #8b6914 100%);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            background: var(--fuji-dark); 
            color: white; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            margin: 0; padding: 0; min-height: 100vh;
            background-image: radial-gradient(circle at top, #4a0000 0%, #1a1a1a 100%);
        }

        .header {
            padding: 25px 15px; text-align: center;
            background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,215,0,0.3);
        }

        h2 { 
            margin: 0; font-size: 1.5rem; letter-spacing: 2px;
            background: var(--metallic-gold); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));
        }

        .main-content { padding: 15px; max-width: 500px; margin: 0 auto; }

        /* æŸ¥è©¢å€å¡Š */
        .query-card {
            background: rgba(255,255,255,0.05); border-radius: 15px; padding: 20px;
            border: 1px solid rgba(255,215,0,0.2); margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .input-group { display: flex; gap: 10px; flex-direction: column; }

        input {
            width: 100%; padding: 15px; font-size: 1.1rem; border-radius: 10px;
            border: 1px solid #444; background: #000; color: #fff;
            text-align: center; outline: none;
        }

        input:focus { border-color: var(--gold); box-shadow: 0 0 10px rgba(255,215,0,0.2); }

        button {
            width: 100%; padding: 15px; font-size: 1.1rem; font-weight: bold;
            background: var(--metallic-gold); border: none; border-radius: 10px; 
            cursor: pointer; color: #221100; transition: 0.2s;
        }

        button:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }

        /* çµæœé¡¯ç¤º */
        #result-container { margin-top: 15px; min-height: 60px; }
        .win-msg {
            background: linear-gradient(45deg, #ffd700, #ff8c00); color: #000;
            padding: 15px; border-radius: 10px; font-weight: 800;
            text-align: center; animation: bounceIn 0.5s ease;
            box-shadow: 0 0 20px rgba(255,215,0,0.4);
        }
        .lose-msg { color: #EBF5DF; text-align: center; font-size: 1.05rem; }

        .prize-highlight {
            color: #d32f2f;
            font-size: 1.4rem;
            font-weight: 900;
            display: inline-block;
            padding: 0 4px;
            text-shadow: 1px 1px 0px rgba(255,255,255,0.5);
        }

        /* çé …é€²åº¦æ¸…å–® */
        .status-section { margin-top: 30px; }
        .section-title { 
            font-size: 0.9rem; color: var(--gold); margin-bottom: 10px; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .grid-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
        }
        .prize-item {
            background: rgba(255,255,255,0.03); border-radius: 8px; padding: 10px;
            border-left: 3px solid #444; display: flex; flex-direction: column;
        }
        .prize-item.active { border-left-color: #d32f2f; background: rgba(211,47,47,0.1); }
        .prize-item.done { border-left-color: #ffd700; background: rgba(255,215,0,0.05); opacity: 0.7; }

        .p-name { font-size: 0.8rem; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .p-count { font-size: 1rem; font-weight: bold; color: #fff; margin-top: 2px; }
        
        /* é‡æ–°æ•´ç†å†·å»æç¤ºæ¨£å¼ */
        #cooldown-msg {
            font-size: 0.7rem;
            color: #ff8888;
            margin-top: 5px;
            display: none;
            text-align: right;
        }

        .loading-dots:after { content: ' .'; animation: dots 1s steps(5, end) infinite; }
        @keyframes dots { 0%, 20% { color: rgba(0,0,0,0); text-shadow: .5em 0 0 rgba(0,0,0,0), 1em 0 0 rgba(0,0,0,0); } 40% { color: white; text-shadow: .5em 0 0 rgba(0,0,0,0), 1em 0 0 rgba(0,0,0,0); } 60% { text-shadow: .5em 0 0 white, 1em 0 0 rgba(0,0,0,0); } 80%, 100% { text-shadow: .5em 0 0 white, 1em 0 0 white; } }
        @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); } 70% { transform: scale(0.9); } 100% { transform: scale(1); opacity: 1; } }
        
        .footer { text-align: center; color: #444; font-size: 0.7rem; margin: 40px 0 20px; }
    </style>
</head>
<body>

<div class="header">
    <h2>2026 FUJIFILM<br>æ—ºå¹´æœƒå¾—çæŸ¥è©¢</h2>
</div>

<div class="main-content">
    <div class="query-card">
        <div class="input-group">
            <input type="text" id="staffId" placeholder="è¼¸å…¥æ‚¨çš„è·ç·¨ (å¦‚: XXXXX)" autocomplete="off">
            <button id="queryBtn" onclick="handleQuery()">ç«‹å³æŸ¥è©¢</button>
        </div>
        <div id="result-container"></div>
    </div>

    <div class="status-section">
        <div class="section-title">
            <span>ğŸ† å„çé …é€²åº¦</span>
            <div>
                <span id="refresh-time" style="font-size: 0.7rem; color: #666;">è¼‰å…¥ä¸­...</span>
                <div id="cooldown-msg">é »ç¹é‡æ–°æ•´ç†ï¼Œç­‰å¾…30ç§’å¾Œå†é‡æ–°æ•´ç†</div>
            </div>
        </div>
        <div id="status-grid" class="grid-container">
            <!-- å‹•æ…‹æ’å…¥ -->
        </div>
    </div>
</div>

<div class="footer">
    &copy; 2026 Fujifilm Taiwan. All Rights Reserved.
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzqdoyJhYiLPlS6pB6TawrBhqdd-KAIcLm7nt4XThUVVKWUpiIMUp7lT4bklZwH5n58BA/exec";
    
    // è¨­å®šé‡æ–°æ•´ç†çš„å†·å»æ™‚é–“ (æ¯«ç§’)ï¼Œä¾‹å¦‚ 15 ç§’
    const REFRESH_COOLDOWN = 15000; 
    const QUERY_COOLDOWN = 8000;

    window.onload = () => {
        // é é¢è¼‰å…¥æ™‚åƒ…åŸ·è¡Œä¸€æ¬¡è®€å–
        loadStatus();
        // ç§»é™¤åŸæœ‰çš„ setInterval è‡ªå‹•åˆ·æ–°é‚è¼¯
    };

// 1. åœ¨ script é–‹é ­å®šç¾©å»¶é²å‡½æ•¸
const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    async function loadStatus() {
        const grid = document.getElementById('status-grid');
        const refreshText = document.getElementById('refresh-time');
        const cooldownMsg = document.getElementById('cooldown-msg');
        
        const now = Date.now();
        const cachedData = localStorage.getItem('fuji_prize_cache');
        const cachedTs = localStorage.getItem('fuji_prize_ts');

        // æª¢æŸ¥å¿«å–å†·å»
        if (cachedData && cachedTs && (now - parseInt(cachedTs) < REFRESH_COOLDOWN)) {
            renderStatus(JSON.parse(cachedData));
            refreshText.innerText = "æœ€å¾Œæ›´æ–°ï¼š" + new Date(parseInt(cachedTs)).toLocaleTimeString();
            cooldownMsg.style.display = "block";
            return;
        }

        try {
            cooldownMsg.style.display = "none";
            
            // ç”Ÿæˆéš¨æ©Ÿå»¶é² (0 åˆ° 5 ç§’)
            const randomDelayMs = Math.floor(Math.random() * 5000); 
            let remainingSeconds = Math.ceil(randomDelayMs / 1000); // ç„¡æ¢ä»¶é€²ä½æˆç§’æ•¸
            
            // --- ä¿®æ”¹å¾Œçš„å€’æ•¸è¨ˆæ™‚é‚è¼¯ ---
            while (remainingSeconds > 0) {
                refreshText.innerText = `é€£ç·šæ’éšŠä¸­... (${remainingSeconds}s)`;
                await sleep(1000); // æ¯æ¬¡ç­‰å¾… 1 ç§’
                remainingSeconds--;
            }
            
            // å€’æ•¸çµæŸï¼Œé–‹å§‹æŠ“å–è³‡æ–™
            refreshText.innerText = "æ­£åœ¨å–å¾—æœ€æ–°è³‡æ–™...";
            const res = await fetch(`${API_URL}?action=prizes&t=${Date.now()}`);
            const prizes = await res.json();
            
            localStorage.setItem('fuji_prize_cache', JSON.stringify(prizes));
            localStorage.setItem('fuji_prize_ts', Date.now().toString());
            
            renderStatus(prizes);
            refreshText.innerText = "æœ€å¾Œæ›´æ–°ï¼š" + new Date().toLocaleTimeString();
        } catch (e) {
            console.error("Fetch Error", e);
            if (cachedData) {
                renderStatus(JSON.parse(cachedData));
                refreshText.innerText = "é€£ç·šä¸ç©© (é¡¯ç¤ºèˆŠè³‡æ–™)";
            } else {
                refreshText.innerText = "ç„¡æ³•é€£ç·šè‡³ä¼ºæœå™¨";
            }
        }
    }

    function renderStatus(prizesFromCloud) {
        const grid = document.getElementById('status-grid');
        if (!prizesFromCloud || prizesFromCloud.length === 0) {
            grid.innerHTML = "<div style='color:#666; text-align:center; grid-column: 1/-1;'>å°šæœªæœ‰çé …è³‡è¨Š</div>";
            return;
        }

        grid.innerHTML = prizesFromCloud.map(p => {
            let statusClass = "";
            let progressText = "";
            
            if (p.current >= p.total) {
                statusClass = "done";
                progressText = `å·²å…¨éƒ¨æŠ½å‡º (${p.total})`;
            } else if (p.current > 0) {
                statusClass = "active";
                progressText = `å·²æŠ½ ${p.current} / å…± ${p.total}`;
            } else {
                statusClass = "";
                progressText = `å¾…æŠ½ (å…± ${p.total} å)`;
            }

            return `
                <div class="prize-item ${statusClass}">
                    <div class="p-name">${p.name}</div>
                    <div style="font-size: 0.7rem; color: #aaa;">æŠ½çäººï¼š${p.drawer}</div>
                    <div class="p-count">${progressText}</div>
                </div>
            `;
        }).join('');
    }

    async function handleQuery() {
        const input = document.getElementById('staffId');
        const btn = document.getElementById('queryBtn');
        const resDiv = document.getElementById('result-container');
        const id = input.value.trim().toUpperCase();

        if (!id) return;
        if (btn.disabled) return;

        btn.disabled = true;
        resDiv.innerHTML = '<div class="lose-msg loading-dots">æ­£åœ¨é€£ç·šè‡³é›²ç«¯</div>';

        try {
            // å€‹äººæŸ¥è©¢ä¸å—é é¢å†·å»é™åˆ¶ï¼Œä½†æœ‰æŒ‰éˆ•å†·å»é™åˆ¶
            const res = await fetch(`${API_URL}?id=${id}&_t=${Date.now()}`);
            const data = await res.json();

            if (data && data.length > 0) {
		celebrate();
                resDiv.innerHTML = data.map(item => `
                    <div class="win-msg">
                        æ­å–œ ${item.name}ï¼<br>
                        ğŸŠ ç²å¾—ï¼š<span class="prize-highlight">${item.prizeName}</span> ğŸŠ<br>
                        <span style="font-size:0.8rem; font-weight:normal;">â€»è«‹æ”œå¸¶è·å·¥å¡è‡³é ˜çè™•é ˜ç</span>
                    </div>
                `).join('');
            } else {
                resDiv.innerHTML = `<div class="lose-msg"> "${id}" å°šæœªä¸­ç<br>è«‹ç­‰å€™ä¸‹ä¸€è¼ªæŠ½ç</div>`;
            }
        } catch (e) {
            resDiv.innerHTML = '<div class="lose-msg" style="color:#ff4444;">ç³»çµ±ç¹å¿™ï¼Œè«‹ç¨å¾Œå†è©¦</div>';
        }

        // å€‹äººæŸ¥è©¢æŒ‰éˆ•å†·å»
        let count = QUERY_COOLDOWN / 1000;
        const timer = setInterval(() => {
            count--;
            if (count <= 0) {
                clearInterval(timer);
                btn.disabled = false;
                btn.innerText = "ç«‹å³æŸ¥è©¢";
            } else {
                btn.innerText = `è«‹ç­‰å€™ (${count}s)`;
            }
        }, 1000);
    }

function celebrate() {
    // ç¬¬ä¸€æ³¢ï¼šä¸­å¿ƒå™´ç™¼
    confetti({
        particleCount: 150,
        spread: 70,
        origin: { y: 0.6 },
        zIndex: 9999
    });

    // ç¬¬äºŒæ³¢ï¼šå…©å´é€£æ“Š (å»¶é²ä¸€é»é»é»)
    setTimeout(() => {
        var duration = 3 * 1000;
        var animationEnd = Date.now() + duration;
        var defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

        function randomInRange(min, max) {
            return Math.random() * (max - min) + min;
        }

        var interval = setInterval(function() {
            var timeLeft = animationEnd - Date.now();
            if (timeLeft <= 0) return clearInterval(interval);

            var particleCount = 50 * (timeLeft / duration);
            confetti(Object.assign({}, defaults, { 
                particleCount, 
                origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } 
            }));
            confetti(Object.assign({}, defaults, { 
                particleCount, 
                origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } 
            }));
        }, 250);
    }, 200);
}
</script>

</body>
</html>